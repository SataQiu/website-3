"use strict";(self.webpackChunkkoordinator_sh=self.webpackChunkkoordinator_sh||[]).push([[5002],{3905:(e,a,r)=>{r.d(a,{Zo:()=>c,kt:()=>m});var t=r(7294);function n(e,a,r){return a in e?Object.defineProperty(e,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[a]=r,e}function o(e,a){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),r.push.apply(r,t)}return r}function p(e){for(var a=1;a<arguments.length;a++){var r=null!=arguments[a]?arguments[a]:{};a%2?o(Object(r),!0).forEach((function(a){n(e,a,r[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(r,a))}))}return e}function i(e,a){if(null==e)return{};var r,t,n=function(e,a){if(null==e)return{};var r,t,n={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],a.indexOf(r)>=0||(n[r]=e[r]);return n}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)r=o[t],a.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=t.createContext({}),l=function(e){var a=t.useContext(s),r=a;return e&&(r="function"==typeof e?e(a):p(p({},a),e)),r},c=function(e){var a=l(e.components);return t.createElement(s.Provider,{value:a},e.children)},k="mdxType",u={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},d=t.forwardRef((function(e,a){var r=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),k=l(r),d=n,m=k["".concat(s,".").concat(d)]||k[d]||u[d]||o;return r?t.createElement(m,p(p({ref:a},c),{},{components:r})):t.createElement(m,p({ref:a},c))}));function m(e,a){var r=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var o=r.length,p=new Array(o);p[0]=d;var i={};for(var s in a)hasOwnProperty.call(a,s)&&(i[s]=a[s]);i.originalType=e,i[k]="string"==typeof e?e:n,p[1]=i;for(var l=2;l<o;l++)p[l]=r[l];return t.createElement.apply(null,p)}return t.createElement.apply(null,r)}d.displayName="MDXCreateElement"},1864:(e,a,r)=>{r.r(a),r.d(a,{assets:()=>s,contentTitle:()=>p,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var t=r(7462),n=(r(7294),r(3905));const o={sidebar_position:1},p=void 0,i={unversionedId:"best-practices/colocation-of-spark-jobs",id:"version-v1.2/best-practices/colocation-of-spark-jobs",title:"colocation-of-spark-jobs",description:"\x3c!--Apache Spark is an analysis engine for large-scale data processing, which is widely used in Big Data, SQL Analysis and Machine Learning scenarios. This tutorial provides a quick practice guide about running Spark jobs in colocation mode with other latency sensitive applications by Koordinator, which is helpful for improving cluster resource utilization. For more details about how to use, compose, and work with Koordinator colocation, please refer to the Introduction",source:"@site/i18n/zh-Hans/docusaurus-plugin-content-docs/version-v1.2/best-practices/colocation-of-spark-jobs.md",sourceDirName:"best-practices",slug:"/best-practices/colocation-of-spark-jobs",permalink:"/zh-Hans/docs/v1.2/best-practices/colocation-of-spark-jobs",draft:!1,editUrl:"https://github.com/koordinator-sh/koordinator.sh/edit/main/docs/best-practices/colocation-of-spark-jobs.md",tags:[],version:"v1.2",lastUpdatedBy:"lowang-bh",lastUpdatedAt:1684912641,formattedLastUpdatedAt:"2023\u5e745\u670824\u65e5",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"docs",previous:{title:"Multi Hierarchy Elastic Quota Management",permalink:"/zh-Hans/docs/v1.2/designs/multi-hierarchy-elastic-quota-management"}},s={},l=[{value:"\u5fc5\u8981\u6761\u4ef6",id:"\u5fc5\u8981\u6761\u4ef6",level:2},{value:"Koordinator\u7ec4\u4ef6",id:"koordinator\u7ec4\u4ef6",level:3},{value:"\u4e3aApache Spark\u5b89\u88c5Kubernetes Operator",id:"\u4e3aapache-spark\u5b89\u88c5kubernetes-operator",level:3},{value:"\u4f7f\u7528Koordinator\u8fd0\u884cSpark\u4efb\u52a1",id:"\u4f7f\u7528koordinator\u8fd0\u884cspark\u4efb\u52a1",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],c={toc:l},k="wrapper";function u(e){let{components:a,...r}=e;return(0,n.kt)(k,(0,t.Z)({},c,r,{components:a,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"spark\u4efb\u52a1\u6df7\u90e8"},"Spark\u4efb\u52a1\u6df7\u90e8"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"Apache Spark"),"\u662f\u5728\u5927\u6570\u636e\uff0cSQL\u5206\u6790\uff0c\u673a\u5668\u5b66\u4e60\u9886\u57df\u5e7f\u6cdb\u4f7f\u7528\u7684\u5927\u6570\u636e\u5904\u7406\u5206\u6790\u5f15\u64ce\u3002\u6b64\u6587\u63d0\u4f9b\u4e86\u4f7f\u7528Koordinator\u5c06Spark\u4efb\u52a1\u548c\u5176\u4ed6\u5ef6\u8fdf\u654f\u611f\u5e94\u7528\u6df7\u5408\u90e8\u7f72\u7684\u5feb\u901f\u6307\u5357\uff0c\u4ee5\u6b64\u6765\u63d0\u5347\u96c6\u7fa4\u7684\u8d44\u6e90\u5229\u7528\u7387\u3002\u4e86\u89e3\u66f4\u591a\u5173\u4e8e\u5982\u4f55\u4f7f\u7528\u3001\u7ec4\u5408\u548c\u6269\u5c55Koordinator\u6df7\u90e8\u7684\u4fe1\u606f\uff0c\u8bf7\u53c2\u8003",(0,n.kt)("a",{parentName:"p",href:"../"},"\u7b80\u4ecb")),(0,n.kt)("h2",{id:"\u5fc5\u8981\u6761\u4ef6"},"\u5fc5\u8981\u6761\u4ef6"),(0,n.kt)("h3",{id:"koordinator\u7ec4\u4ef6"},"Koordinator\u7ec4\u4ef6"),(0,n.kt)("p",null,"\u63d0\u4ea4\u6df7\u90e8spark\u4efb\u52a1\u4e4b\u524d\uff0c\u9700\u8981\u786e\u8ba4\u6240\u6709",(0,n.kt)("inlineCode",{parentName:"p"},"Koordinator"),"\u7ec4\u4ef6\u5df2\u7ecf\u6210\u529f\u5b89\u88c5\u3002\u8bf7\u53c2\u8003",(0,n.kt)("a",{parentName:"p",href:"../installation"},"\u5b89\u88c5"),"\u6307\u5357\u3002"),(0,n.kt)("h3",{id:"\u4e3aapache-spark\u5b89\u88c5kubernetes-operator"},"\u4e3aApache Spark\u5b89\u88c5Kubernetes Operator"),(0,n.kt)("p",null,"\u4e3a\u4e86\u65b9\u4fbf\u5728\u96c6\u7fa4\u4e2d\u63d0\u4ea4Spark\u4efb\u52a1\uff0c\u672c\u6587\u5f15\u5165Kubernetes Operator\uff0c\u4f7f\u7528\u7528\u6237\u81ea\u5b9a\u4e49\u8d44\u6e90(CRD)\u7ba1\u7406Spark\u5e94\u7528\u3002"),(0,n.kt)("p",null,"\u6839\u636e",(0,n.kt)("a",{parentName:"p",href:"https://github.com/koordinator-sh/koordinator/tree/main/examples/spark-operator-chart"},"Helm chart"),"\u7684\u5e2e\u52a9\u6587\u6863\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5b89\u88c5Spark Operator\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ helm install koord-spark-operator ./spark-operator-chart/ --namespace spark-operator\n")),(0,n.kt)("p",null,"\u5b89\u88c5\u8fd9\u4e2a",(0,n.kt)("inlineCode",{parentName:"p"},"chart"),"\u5c06\u521b\u5efa\u540d\u4e3a",(0,n.kt)("inlineCode",{parentName:"p"},"spark-operator"),"\u7684\u547d\u540d\u7a7a\u95f4(\u5982\u679c\u4e0d\u5b58\u5728\u7684\u60c5\u51b5\u4e0b)\uff0c\u9664\u6b64\u4e4b\u5916\uff0c",(0,n.kt)("inlineCode",{parentName:"p"},"helm"),"\u4e5f\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a",(0,n.kt)("inlineCode",{parentName:"p"},"spark-operator"),"\u7684\u5e94\u7528\u5e76\u4e3a\u5b83\u8bbe\u7f6e\u76f8\u5e94\u7684RBAC\u6743\u9650\u3002\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u68c0\u67e5",(0,n.kt)("inlineCode",{parentName:"p"},"helm"),"\u7684\u53d1\u5e03\u72b6\u6001\u770b\u5230",(0,n.kt)("inlineCode",{parentName:"p"},"operator"),"\u5df2\u7ecf\u6210\u529f\u8fd0\u884c\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ helm status --namespace spark-operator koord-spark-operator\n")),(0,n.kt)("h2",{id:"\u4f7f\u7528koordinator\u8fd0\u884cspark\u4efb\u52a1"},"\u4f7f\u7528Koordinator\u8fd0\u884cSpark\u4efb\u52a1"),(0,n.kt)("p",null,"\u7531\u4e8eSpark\u7684\u7279\u6b8a\u673a\u5236\uff0c\u9700\u8981k8s\u7684",(0,n.kt)("inlineCode",{parentName:"p"},"service account"),"\u6765\u7ba1\u7406Spark\u7684",(0,n.kt)("inlineCode",{parentName:"p"},"executor"),"\u9a71\u52a8\u526f\u672c\uff0c\u56e0\u6b64",(0,n.kt)("inlineCode",{parentName:"p"},"service account"),"\u5fc5\u987b\u7ecf\u8fc7\u7ecf\u8fc7\u5408\u9002\u7684\u6388\u6743\u3002\u8bf7\u5728\u63d0\u4ea4\u4efb\u52a1\u524d\uff0c\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u521b\u5efa",(0,n.kt)("inlineCode",{parentName:"p"},"spark-demo"),"\u547d\u540d\u7a7a\u95f4\u4ee5\u53ca\u540d\u4e3a",(0,n.kt)("inlineCode",{parentName:"p"},"spark"),"\u7684",(0,n.kt)("inlineCode",{parentName:"p"},"service account"),"\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ kubectl apply -f examples/spark-jobs/service-account.yaml\n")),(0,n.kt)("p",null,"\u7136\u540e\uff0c\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa\u6df7\u90e8\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u8fd9\u6837\u63d0\u4ea4\u5230",(0,n.kt)("inlineCode",{parentName:"p"},"spark-demo"),"\u547d\u540d\u7a7a\u95f4\u7684\u4efb\u52a1\u624d\u4f1a\u4ee5\u6df7\u90e8\u6a21\u5f0f\u8fd0\u884c\u3002\u8bf7\u53c2\u8003",(0,n.kt)("a",{parentName:"p",href:"../user-manuals/colocation-profile"},"\u6559\u7a0b"),"\u83b7\u53d6\u66f4\u591a\u6709\u5173\u6df7\u90e8\u914d\u7f6e\u7684\u4fe1\u606f\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ kubectl apply -f examples/spark-jobs/cluster-colocation-profile.yaml\n")),(0,n.kt)("p",null,"\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5f80",(0,n.kt)("inlineCode",{parentName:"p"},"spark-demo"),"\u547d\u540d\u7a7a\u95f4\u63d0\u4ea4\u4e00\u4e2a",(0,n.kt)("inlineCode",{parentName:"p"},"Spark TC"),"\u793a\u4f8b\u4efb\u52a1\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ kubectl apply -f examples/spark-jobs/spark-tc-complex.yaml\n")),(0,n.kt)("p",null,"\u7136\u540e\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u68c0\u67e5Spark\u5e94\u7528\u7684\u72b6\u6001\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ kubectl get sparkapplication -n spark-demo spark-tc-complex\n")),(0,n.kt)("p",null,"\u5c06\u663e\u793a\u7c7b\u4f3c\u5982\u4e0b\u5185\u5bb9\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-text"},"NAME                      STATUS      ATTEMPTS   START                    FINISH                 AGE\nspark-tc-complex          RUNNING     1          2022-03-30T09:11:22Z     <no value>             14s\n")),(0,n.kt)("p",null,"\u73b0\u5728\uff0c\u63d0\u4ea4\u5230",(0,n.kt)("inlineCode",{parentName:"p"},"spark-demo"),"\u547d\u540d\u7a7a\u95f4\u7684\u6240\u6709pods\u90fd\u5c06\u5207\u6362\u5230\u6df7\u90e8\u72b6\u6001\u3002\u6bd4\u5982\uff0c\u68c0\u67e5\u540d\u4e3a",(0,n.kt)("inlineCode",{parentName:"p"},"spark-driver"),"\u7684pod\u7684yaml\uff0c\u6211\u4eec\u5c06\u770b\u5230\u6807\u7b7e",(0,n.kt)("inlineCode",{parentName:"p"},"koordinator.sh/qosClass: BE"),"\u4ee5\u53ca",(0,n.kt)("inlineCode",{parentName:"p"},"kubernetes.io/batch-cpu"),"\u88ab",(0,n.kt)("inlineCode",{parentName:"p"},"Colocation Profile"),"\u6210\u529f\u6ce8\u5165\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    koordinator.sh/qosClass: BE\n    spark-role: driver\n  ...\nspec:\n  containers:\n  -  args:\n      - driver\n      - --properties-file\n      - /opt/spark/conf/spark.properties\n      - --class\n      - org.apache.spark.examples.SparkTC\n      - local:///opt/spark/examples/jars/spark-examples_2.12-3.2.1-tc1.2.jar\n      resources:\n        limits:\n          kubernetes.io/batch-cpu: "1000"\n          kubernetes.io/batch-memory: 3456Mi\n        requests:\n          kubernetes.io/batch-cpu: "1000"\n          kubernetes.io/batch-memory: 3456Mi\n  ...\n')),(0,n.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,n.kt)("p",null,"\u5728",(0,n.kt)("inlineCode",{parentName:"p"},"Koordinator"),"\u7684\u5e2e\u52a9\u4e0b\uff0c\u5f53pod\u7684\u8d44\u6e90\u4f7f\u7528\u6bd4\u8f83\u7a7a\u95f2\u7684\u65f6\u5019\uff0c\u88ab\u7533\u8bf7\u7684\u8d44\u6e90\u53ef\u4ee5\u91cd\u65b0\u5206\u914d\u7ed9\u5176\u4ed6\u901a\u8fc7\u8d85\u5356\u673a\u5236\u6df7\u90e8\u7684pods\uff0c\u8fd9\u5c06\u5f88\u5927\u7a0b\u5ea6\u63d0\u9ad8\u96c6\u7fa4\u7684\u8d44\u6e90\u5229\u7528\u7387\u3002"),(0,n.kt)("p",null,"\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u73af\u5883\uff0c\u5728\u63d0\u4ea4",(0,n.kt)("inlineCode",{parentName:"p"},"Spark"),"\u4efb\u52a1\u524d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u96c6\u7fa4\u7684\u53ef\u5206\u914d\u8d44\u6e90\u5df2\u5168\u5206\u914d\u51fa\u53bb\u800c\u5b9e\u9645\u8d44\u6e90\u4f7f\u7528\u7387\u4ecd\u5904\u4e8e\u5f88\u4f4e\u7684\u6c34\u5e73\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ kubectl describe node\n    Allocated resources:\n    Resource                 Requests\n    cpu                      7620m (95.25%)\n  \n$ kubectl top node\n    NAME                            CPU(cores)              CPU%\n    cn-hangzhou.your-node-1         1190m                   14.8%\n    cn-hangzhou.your-node-2         1620m                   20.25%\n")),(0,n.kt)("p",null,"\u5f53\u63d0\u4ea4\u6df7\u90e8\u7684",(0,n.kt)("inlineCode",{parentName:"p"},"Spark"),"\u4efb\u52a1\u540e\uff0c\u8fd9\u4e9b\u6ca1\u88ab\u4f7f\u7528\u7684\u8d44\u6e90\u901a\u8fc7",(0,n.kt)("inlineCode",{parentName:"p"},"batch priority"),"\u4f18\u5148\u7ea7\u5c06\u91cd\u65b0\u5206\u914d\u7ed9",(0,n.kt)("inlineCode",{parentName:"p"},"Spark"),"\u4efb\u52a1\u7684pods\u3002\u56e0\u6b64\uff0c\u96c6\u7fa4\u7684\u8d44\u6e90\u5229\u7528\u7387\u63d0\u5347\u4e86\u4e00\u4e2a\u7b49\u7ea7\u3002"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},"$ kubectl top node\nNAME                            CPU(cores)              CPU%\ncn-hangzhou.your-node-1         4077m                   52%\ncn-hangzhou.your-node-2         3830m                   49%\n")))}u.isMDXComponent=!0}}]);